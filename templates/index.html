<!DOCTYPE html>
<html>
<head>
    <title>Docker Compose Remote Deploy</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        textarea { width: 100%; height: 250px; font-family: monospace; }
        pre { background: #f0f0f0; padding: 10px; overflow-x: auto; max-height: 200px; }
        .section { margin-bottom: 30px; }
        button { padding: 10px 20px; font-size: 16px; }
        .status-ok { color: green; }
        .status-error { color: red; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
        th { background: #eee; }
    </style>
</head>
<body>
    <h1>Docker Compose Remote Deployment</h1>

    <div class="section">
        <h2>Upload / Paste Docker Compose YAML</h2>
        <textarea id="composeText" placeholder="Paste your docker-compose YAML here..."></textarea><br>
        <button onclick="deployCompose()">Deploy Compose</button>
        <div id="deployResult"></div>
    </div>

    <div class="section">
        <h2>Last Deployment Logs</h2>
        <pre id="logs"></pre>
    </div>

    <div class="section">
        <h2>Docker Status (auto refresh every 10s)</h2>
        <button onclick="refreshStatus()">Refresh Now</button>

        <h3>Containers</h3>
        <div id="containers"></div>

        <h3>Images</h3>
        <div id="images"></div>

        <h3>Networks</h3>
        <div id="networks"></div>

        <h3>Volumes</h3>
        <div id="volumes"></div>
    </div>

<script>
async function deployCompose() {
    const text = document.getElementById('composeText').value;
    if (!text.trim()) {
        alert("Please paste docker-compose YAML");
        return;
    }
    document.getElementById('deployResult').innerText = "Deploying...";
    const res = await fetch('/deploy', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({compose: text})
    });
    const data = await res.json();
    document.getElementById('deployResult').innerText = data.message;
    fetchLogs();
    refreshStatus();
}

async function fetchLogs() {
    const res = await fetch('/logs');
    const data = await res.json();
    document.getElementById('logs').innerText = data.logs.join("\\n");
}

async function refreshStatus() {
    // Containers
    let res = await fetch('/api/containers');
    let data = await res.json();
    document.getElementById('containers').innerHTML = renderTable(data, ["Id", "Names", "Image", "State", "Status"]);

    // Images
    res = await fetch('/api/images');
    data = await res.json();
    document.getElementById('images').innerHTML = renderTable(data, ["Id", "RepoTags", "Size"]);

    // Networks
    res = await fetch('/api/networks');
    data = await res.json();
    document.getElementById('networks').innerHTML = renderTable(data, ["Id", "Name", "Driver"]);

    // Volumes
    res = await fetch('/api/volumes');
    data = await res.json();
    if (data.volumes) {
        document.getElementById('volumes').innerHTML = renderTable(data.volumes, ["Name", "Driver", "Mountpoint"]);
    } else {
        document.getElementById('volumes').innerHTML = "No volumes";
    }
}

function renderTable(data, columns) {
    if (!data || data.length === 0) return "No data";
    let html = "<table><tr>";
    for (const col of columns) {
        html += `<th>${col}</th>`;
    }
    html += "</tr>";

    for (const row of data) {
        html += "<tr>";
        for (const col of columns) {
            let val = row[col];
            if (Array.isArray(val)) val = val.join(", ");
            html += `<td>${val !== undefined ? val : ""}</td>`;
        }
        html += "</tr>";
    }
    html += "</table>";
    return html;
}

// Auto refresh every 10 seconds
setInterval(() => {
    refreshStatus();
    fetchLogs();
}, 10000);

window.onload = () => {
    refreshStatus();
    fetchLogs();
};
</script>

</body>
</html>
